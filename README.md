# Characterization of Hemodynamic Response Function (HRF) at resting state




## Step 1: HRF estimation 
Compute the HRF and its features from resting state fMRI data. The method uses the toolbox from the GitHub repository:  https://github.com/compneuro-da/rsHRF and 

```
compute_hrf(input_dir)
``` 

where `input_dir` is the dataset to use and must contains Detrend_4DVolume.nii (or .nii.gz) files. `compute_hrf.m` compute the HRF and its features

## Step 2: Registration to the MNI space 

```
./func2standard_registration.sh
```

## Step 3: Extract regions of interest 
there are two types of analysis: analysis between white matter (WM) and gray matter (GM) or by WM tracts.
1. If analyzing white and gray matter use `compute_wm_gm_values.m`
```
compute_wm_gm_values(INPUT_DIR, OUT_DIR, PARAM, PATH_WM, PATH_GM)
```
where `INPUT_DIR` is the input directory containing the data registered to the MNI space. `OUT_DIR` is the output directory to save the csv files containing the WM and GM values extracted. `PARAM` is the HRF feature name (i.e. DipHeight). `PATH_WM`, `PATH_GM` are the path to the MNI WM and GM masks.

1. If analyzing the HRF across Regions Of Interests (ROIs) use `extract_rois.m`

```
extract_rois(INPUT_DIR, OUT_DIR, PARAM, TEMPLATE)
```
where `INPUT_DIR` is the input directory containing the data registered to the MNI space. `OUT_DIR` is the output directory to save the csv files containing the values extracted in the ROIs. `PARAM` is the HRF feature name (i.e. DipHeight). `TEMPLATE` is the path to the MNI template containing the WM tracts (i.e. JHU 48 WM labels).


## Step 4: Harmonization with ComBAT
The approach used the harmonization technic ComBAT, detailed in the GitHub repository https://github.com/Jfortin1/ComBatHarmonization
1. Before applying ComBAT, the input csv file needs to contains sex, age, scanners and protocols informations
2. Then harmonize the data 

```
python3 ComBAT_hrf.py --in_csv input_csv --TR_thd 100 --model_thd 46 --gm_wm GM WM --effects TR Scanner --covariates Sex --out_csv output_csv
```

where `scanner_thd` is the threshold to select the number of scanner and `TR_thd` is the threshold to select the number of repetition times. `effects` are the parameters to harmonized and `covariates` are the covariates to include. `--gm_wm` is the parameter to harmonize the WM and GM and `--rois` is the parameter to use when harmonizing ROIs.

3. (optional) Visualize the before/after harmonization on data. 
```
python3 display_harmonization_effects.py --in_dir input_dir --cols WM WM_harmonized  --effects TR Scanner --out_png out.png
```

where `input_dir` is the directory containing the csv files generated by `ComBAT.py`

4. Performance evaluation

```
python3 compute_score_and_pval.py --in_dir input_dir --type cohen --effect Manufacturer –- tissus WM WM_harmonized -–out out_dir
```

where `input_dir` is the directory containing the csv files generated by `ComBAT.py`, `type` is the type of test (`cohen` or `kruskal`), `effect` is the effect to study (`Manufacturer` or `Age`) and `out` is the output directory to save the output files.


## Step 5: Regression model and changes with aging
there are two types of regression model linear or cubic regression where the model is defined as follow:
$$ Y = b_{0} + \sum_{k=1}^{k=4} b_{k}B_{k}(X) $$ 
where $X$ is the age, $Y$ is the mean value of the feature, $b_0$ is the intercept, and the $b_k$ are the coefficients associated of the B-spline $B_k$.




1. If analyzing two tissus/columns use model_changes_with_aging
```
python3 model_changes_with_aging.py --in_dir input_dir --covariates Sex --cols WM_harmonized GM_harmonized --model cubic --TR 0.607 3 --out_png out.png
```
where  `input_dir` is the directory containing the csv files generated by `ComBAT.py`, `covariates` are the covariates to include, `cols` the two columns to analyze, `model` is the type of model either `linear` or `cubic`. `TR` is the list of the repetition time used to select the data.

2. If analyzing the HRF across Regions Of Interests (ROIs) use 
```
python3 plot_changes_aging_rois.py--in_dir input_dir --covariates Sex --model linear --roi_csv roi_csv_file --out_dir output_dir
```
where  `input_dir` is the directory containing the csv files generated by `ComBAT.py`, `covariates` are the covariates to include, `model` is the type of model either `linear` or `cubic`. `roi_csv_file` is a csv file containing the label, name and location (Left, Right or Middle) of each WM tract. `output_dir` is the output directory where to save the output files.